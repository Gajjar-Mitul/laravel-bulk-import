<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Upload Tester</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-cloud-upload me-2"></i>Bulk Upload Tester</h5>
                    </div>
                    <div class="card-body">
                        <!-- Generate Test Images -->
                        <div class="mb-4">
                            <h6>Generate Test Images</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Number of Images:</label>
                                    <input type="number" id="imageCount" class="form-control" value="10" min="1" max="500">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button class="btn btn-success" onclick="generateAndUpload()">
                                        <i class="bi bi-images me-2"></i>Generate & Upload
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- File Upload -->
                        <div class="mb-4">
                            <h6>Upload Existing Files</h6>
                            <input type="file" id="fileInput" class="form-control" multiple accept="image/*">
                            <div class="mt-2">
                                <button class="btn btn-primary" onclick="uploadSelectedFiles()">
                                    <i class="bi bi-upload me-2"></i>Upload Selected Files
                                </button>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div id="progressContainer" class="d-none">
                            <h6>Upload Progress</h6>
                            <div class="progress mb-3">
                                <div id="overallProgress" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <div id="progressDetails" class="small text-muted"></div>
                        </div>

                        <!-- Results -->
                        <div id="resultsContainer" class="d-none">
                            <h6>Results</h6>
                            <div id="results"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadStats = {
            total: 0,
            completed: 0,
            failed: 0,
            startTime: null
        };

        // Generate canvas-based test images and upload them
        async function generateAndUpload() {
            const count = parseInt(document.getElementById('imageCount').value);

            if (count > 500) {
                alert('Maximum 500 images allowed for browser testing');
                return;
            }

            showProgress();
            uploadStats = { total: count, completed: 0, failed: 0, startTime: Date.now() };

            for (let i = 1; i <= count; i++) {
                try {
                    updateProgressDetails(`Generating image ${i}/${count}...`);

                    const imageBlob = generateTestImage(i);
                    const filename = `generated_test_${i}.png`;

                    updateProgressDetails(`Uploading image ${i}/${count}...`);
                    await uploadBlob(imageBlob, filename);

                    uploadStats.completed++;
                } catch (error) {
                    console.error(`Failed to process image ${i}:`, error);
                    uploadStats.failed++;
                }

                updateOverallProgress();
            }

            showResults();
        }

        // Upload selected files
        async function uploadSelectedFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);

            if (files.length === 0) {
                alert('Please select files first');
                return;
            }

            showProgress();
            uploadStats = { total: files.length, completed: 0, failed: 0, startTime: Date.now() };

            for (let i = 0; i < files.length; i++) {
                try {
                    updateProgressDetails(`Uploading ${files[i].name} (${i+1}/${files.length})...`);
                    await uploadBlob(files[i], files[i].name);
                    uploadStats.completed++;
                } catch (error) {
                    console.error(`Failed to upload ${files[i].name}:`, error);
                    uploadStats.failed++;
                }

                updateOverallProgress();
            }

            showResults();
        }

        // Generate a test image using canvas
        function generateTestImage(index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Random dimensions
            const width = 400 + Math.random() * 400;
            const height = 300 + Math.random() * 300;
            canvas.width = width;
            canvas.height = height;

            // Random background
            ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 50%)`;
            ctx.fillRect(0, 0, width, height);

            // Add some shapes
            for (let i = 0; i < 5; i++) {
                ctx.fillStyle = `hsla(${Math.random() * 360}, 70%, 50%, 0.7)`;
                ctx.fillRect(
                    Math.random() * width * 0.5,
                    Math.random() * height * 0.5,
                    Math.random() * width * 0.5,
                    Math.random() * height * 0.5
                );
            }

            // Add text
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.fillText(`Test Image #${index}`, 10, 30);
            ctx.font = '14px Arial';
            ctx.fillText(new Date().toISOString(), 10, 55);
            ctx.fillText(`${Math.round(width)}x${Math.round(height)}`, 10, 75);

            // Convert to blob
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/png', 0.8);
            });
        }

        // Upload blob using chunked upload API
        async function uploadBlob(blob, filename) {
            const chunkSize = 1024 * 1024; // 1MB chunks
            const totalSize = blob.size;
            const totalChunks = Math.ceil(totalSize / chunkSize);

            // Calculate checksum (simplified)
            const checksum = await calculateChecksum(blob);

            // Initialize upload
            const initResponse = await fetch('/api/uploads/initialize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    filename: filename,
                    total_size: totalSize,
                    total_chunks: totalChunks,
                    mime_type: blob.type || 'image/png',
                    checksum: checksum
                })
            });

            const initResult = await initResponse.json();

            if (!initResult.success) {
                throw new Error(`Init failed: ${initResult.message}`);
            }

            const uploadUuid = initResult.data.upload_uuid;

            // Upload chunks
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                const start = chunkIndex * chunkSize;
                const end = Math.min(start + chunkSize, totalSize);
                const chunkBlob = blob.slice(start, end);

                const formData = new FormData();
                formData.append('upload_uuid', uploadUuid);
                formData.append('chunk_index', chunkIndex);
                formData.append('chunk_size', chunkBlob.size);
                formData.append('chunk_file', chunkBlob);

                const chunkResponse = await fetch('/api/uploads/chunk', {
                    method: 'POST',
                    body: formData
                });

                const chunkResult = await chunkResponse.json();

                if (!chunkResult.success) {
                    throw new Error(`Chunk ${chunkIndex} failed: ${chunkResult.message}`);
                }
            }

            return uploadUuid;
        }

        // Simple checksum calculation
        async function calculateChecksum(blob) {
            const arrayBuffer = await blob.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // UI helper functions
        function showProgress() {
            document.getElementById('progressContainer').classList.remove('d-none');
            document.getElementById('resultsContainer').classList.add('d-none');
        }

        function updateOverallProgress() {
            const percentage = ((uploadStats.completed + uploadStats.failed) / uploadStats.total) * 100;
            document.getElementById('overallProgress').style.width = percentage + '%';
            document.getElementById('overallProgress').textContent = Math.round(percentage) + '%';
        }

        function updateProgressDetails(message) {
            document.getElementById('progressDetails').textContent = message;
        }

        function showResults() {
            const elapsed = (Date.now() - uploadStats.startTime) / 1000;
            const rate = (uploadStats.completed + uploadStats.failed) / elapsed;

            const resultsHtml = `
                <div class="alert alert-info">
                    <strong>Upload Complete!</strong><br>
                    ‚úÖ Successful: ${uploadStats.completed}<br>
                    ‚ùå Failed: ${uploadStats.failed}<br>
                    ‚è±Ô∏è Time: ${elapsed.toFixed(2)} seconds<br>
                    üìà Rate: ${rate.toFixed(2)} images/sec
                </div>
            `;

            document.getElementById('results').innerHTML = resultsHtml;
            document.getElementById('resultsContainer').classList.remove('d-none');
        }
    </script>
</body>
</html>
